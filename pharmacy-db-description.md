# Структура базы данных мобильного приложения аптечной сети

## Таблицы и их описание

### 1. ПОЛЬЗОВАТЕЛИ (Users)
Таблица для хранения информации о клиентах аптечной сети.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_пользователя** | INTEGER (PK) | Уникальный идентификатор клиента |
| ФИО | VARCHAR(255) | Отображаемое имя владельца счета |
| Контактные_данные | VARCHAR(100) | Номер телефона или электронная почта для авторизации |
| Хэшированный_пароль | VARCHAR(255) | Безопасная аутентификация (хэш SHA-256 или bcrypt) |
| Баланс_бонусов | DECIMAL(10,2) | Текущее количество бонусных баллов на счету |
| Язык_интерфейса | ENUM('ru', 'en') | Выбранный язык интерфейса |

**Связи:**
- 1:M с таблицей ЗАКАЗЫ
- 1:M с таблицей УВЕДОМЛЕНИЯ

---

### 2. ТОВАРЫ (Products)
Каталог лекарств и товаров для здоровья.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_товара** | INTEGER (PK) | Уникальный номер лекарства или товара для здоровья |
| Наименование | VARCHAR(255) | Название препарата или товара |
| Описание | TEXT | Состав, показания, противопоказания, способ применения |
| Цена | DECIMAL(10,2) | Стоимость в рублях |
| Категория | VARCHAR(100) | Тип товара («Лекарства», «Витамины», «Гигиена», «Медтехника» и т.д.) |
| Рецептурный_товар | BOOLEAN | Признак того, отпускается ли товар по рецепту («да» / «нет») |
| Производитель | VARCHAR(255) | Наименование фармацевтической компании или бренда |

**Связи:**
- 1:M с таблицей СОСТАВ_ЗАКАЗА
- 1:M с таблицей НАЛИЧИЕ

---

### 3. АПТЕКИ (Pharmacies)
Информация о точках продаж аптечной сети.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_аптеки** | INTEGER (PK) | Уникальный номер точки продаж |
| Адрес | VARCHAR(500) | Полный почтовый адрес аптеки |
| Широта | DECIMAL(10,8) | Географическая широта для отображения на карте |
| Долгота | DECIMAL(11,8) | Географическая долгота для отображения на карте |
| Контактный_телефон | VARCHAR(20) | Номер для связи с аптекой |

**Связи:**
- 1:M с таблицей НАЛИЧИЕ
- 1:M с таблицей ЗАКАЗЫ (для самовывоза)

---

### 4. НАЛИЧИЕ (Stock/Inventory)
Связующая таблица между товарами и аптеками. Показывает остатки товаров в каждой аптеке.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_наличия** | INTEGER (PK) | Уникальный идентификатор записи |
| ID_товара | INTEGER (FK) | Ссылка на товар |
| ID_аптеки | INTEGER (FK) | Ссылка на аптеку |
| Количество | INTEGER | Число единиц товара, доступных для продажи в аптеке |

**Связи:**
- M:1 с таблицей ТОВАРЫ
- M:1 с таблицей АПТЕКИ

**Индексы:**
- Composite index на (ID_товара, ID_аптеки) для быстрого поиска наличия

---

### 5. ЗАКАЗЫ (Orders)
История заказов клиентов с информацией о доставке и статусе.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_заказа** | INTEGER (PK) | Уникальный номер заказа |
| ID_пользователя | INTEGER (FK) | Ссылка на клиента, оформившего заказ |
| Статус | ENUM | Текущее состояние заказа: «Создан», «Принят», «Готов к выдаче», «Доставлен», «Отменён» |
| Способ_получения | ENUM | Тип доставки: «Самовывоз» / «Доставка» |
| Адрес_доставки | VARCHAR(500) | Указывается при выборе доставки (опционально) |
| ID_аптеки | INTEGER (FK) | Аптека для самовывоза (опционально) |
| Дата_создания | TIMESTAMP | Дата и время оформления заказа |
| Общая_сумма | DECIMAL(10,2) | Итоговая стоимость заказа в рублях |

**Связи:**
- M:1 с таблицей ПОЛЬЗОВАТЕЛИ
- M:1 с таблицей АПТЕКИ (nullable, только для самовывоза)
- 1:M с таблицей СОСТАВ_ЗАКАЗА

**Бизнес-правила:**
- Если Способ_получения = 'Доставка', то Адрес_доставки обязателен
- Если Способ_получения = 'Самовывоз', то ID_аптеки обязателен

---

### 6. СОСТАВ_ЗАКАЗА (Order_Items)
Детализация заказа — список товаров в конкретном заказе.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_состава** | INTEGER (PK) | Уникальный идентификатор записи |
| ID_заказа | INTEGER (FK) | Ссылка на заказ |
| ID_товара | INTEGER (FK) | Ссылка на товар |
| Количество | INTEGER | Число единиц товара в данной позиции |
| Цена_на_момент_заказа | DECIMAL(10,2) | Стоимость товара в момент оформления (для сохранения истории цен) |

**Связи:**
- M:1 с таблицей ЗАКАЗЫ
- M:1 с таблицей ТОВАРЫ

**Примечание:**
Поле `Цена_на_момент_заказа` важно для фиксации цены в момент покупки, так как цены в каталоге могут меняться.

---

### 7. УВЕДОМЛЕНИЯ (Notifications)
Push-уведомления и сообщения для пользователей.

| Поле | Тип | Описание |
|------|-----|----------|
| **ID_уведомления** | INTEGER (PK) | Уникальный номер сообщения |
| ID_пользователя | INTEGER (FK) | Получатель уведомления |
| Тип_уведомления | ENUM | Категория: «статус заказа», «акция», «напоминание о приёме» |
| Текст_сообщения | TEXT | Содержание уведомления |
| Признак_прочтения | BOOLEAN | Статус: «прочитано» (TRUE) / «не прочитано» (FALSE) |
| Дата_создания | TIMESTAMP | Время отправки уведомления |

**Связи:**
- M:1 с таблицей ПОЛЬЗОВАТЕЛИ

---

## Схема связей (Entity-Relationship)

```
ПОЛЬЗОВАТЕЛИ (1) ----< (M) ЗАКАЗЫ
ПОЛЬЗОВАТЕЛИ (1) ----< (M) УВЕДОМЛЕНИЯ

ЗАКАЗЫ (1) ----< (M) СОСТАВ_ЗАКАЗА
ЗАКАЗЫ (M) >---- (0..1) АПТЕКИ [для самовывоза]

ТОВАРЫ (1) ----< (M) СОСТАВ_ЗАКАЗА
ТОВАРЫ (1) ----< (M) НАЛИЧИЕ

АПТЕКИ (1) ----< (M) НАЛИЧИЕ
```

---

## Индексы для оптимизации

1. **ПОЛЬЗОВАТЕЛИ:**
   - UNIQUE INDEX на Контактные_данные (для быстрой авторизации)

2. **ТОВАРЫ:**
   - INDEX на Категория (для фильтрации)
   - INDEX на Рецептурный_товар (для разделения товаров)

3. **НАЛИЧИЕ:**
   - COMPOSITE INDEX на (ID_товара, ID_аптеки)
   - INDEX на ID_аптеки (для поиска всех товаров в аптеке)

4. **ЗАКАЗЫ:**
   - INDEX на ID_пользователя (для истории заказов)
   - INDEX на Статус (для фильтрации активных заказов)
   - INDEX на Дата_создания (для сортировки)

5. **УВЕДОМЛЕНИЯ:**
   - INDEX на (ID_пользователя, Признак_прочтения)
   - INDEX на Дата_создания

---

## Примеры SQL-запросов

### Поиск товара в ближайших аптеках
```sql
SELECT 
    А.Адрес,
    А.Контактный_телефон,
    Н.Количество,
    Т.Цена
FROM НАЛИЧИЕ Н
JOIN ТОВАРЫ Т ON Н.ID_товара = Т.ID_товара
JOIN АПТЕКИ А ON Н.ID_аптеки = А.ID_аптеки
WHERE Т.ID_товара = ?
  AND Н.Количество > 0
ORDER BY А.ID_аптеки;
```

### История заказов пользователя
```sql
SELECT 
    З.ID_заказа,
    З.Дата_создания,
    З.Статус,
    З.Общая_сумма,
    З.Способ_получения
FROM ЗАКАЗЫ З
WHERE З.ID_пользователя = ?
ORDER BY З.Дата_создания DESC;
```

### Детальная информация о заказе
```sql
SELECT 
    Т.Наименование,
    СЗ.Количество,
    СЗ.Цена_на_момент_заказа,
    (СЗ.Количество * СЗ.Цена_на_момент_заказа) AS Сумма
FROM СОСТАВ_ЗАКАЗА СЗ
JOIN ТОВАРЫ Т ON СЗ.ID_товара = Т.ID_товара
WHERE СЗ.ID_заказа = ?;
```

### Непрочитанные уведомления
```sql
SELECT 
    ID_уведомления,
    Тип_уведомления,
    Текст_сообщения,
    Дата_создания
FROM УВЕДОМЛЕНИЯ
WHERE ID_пользователя = ?
  AND Признак_прочтения = FALSE
ORDER BY Дата_создания DESC;
```

---

## Рекомендации по реализации

1. **Безопасность:**
   - Хэшировать пароли с использованием bcrypt или Argon2
   - Использовать HTTPS для всех API-запросов
   - Применять JWT токены для авторизации

2. **Производительность:**
   - Создать индексы на часто используемых полях
   - Использовать кэширование (Redis) для каталога товаров
   - Партиционирование таблицы ЗАКАЗЫ по дате

3. **Масштабируемость:**
   - Репликация базы данных (master-slave)
   - Использовать CDN для изображений товаров
   - Очередь сообщений (RabbitMQ) для уведомлений

4. **Мониторинг:**
   - Логирование всех изменений заказов
   - Отслеживание остатков товаров в реальном времени
   - Алерты на критические изменения в БД
