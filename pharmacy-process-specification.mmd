graph TB
    Start([Начало процесса]) --> A1[Пользователь: Открывает приложение]
    A1 --> A2[Пользователь: Ищет нужные лекарства]
    A2 --> A3[Пользователь: Добавляет товары в корзину]
    A3 --> A4{Пользователь: Способ получения?}
    
    A4 -->|Доставка| A5[Пользователь: Указывает адрес]
    A4 -->|Самовывоз| A6[Пользователь: Выбирает аптеку на карте]
    
    A5 --> A7[Пользователь: Выбирает способ оплаты]
    A6 --> A7
    
    A7 --> B1[Приложение: Формирует заказ]
    B1 --> B2[Приложение: Отправляет данные на сервер]
    
    B2 --> C1[API-сервер: Создаёт заказ в БД]
    C1 --> C2{API-сервер: Товары в наличии?}
    
    C2 -->|Нет| E1[Приложение: Уведомление - товара нет]
    E1 --> End1([Конец - отмена])
    
    C2 -->|Да| C3[API-сервер: Резервирует товары]
    C3 --> C4{API-сервер: Оплата онлайн?}
    
    C4 -->|Да| D1[Платёжная система: Обрабатывает платёж]
    D1 --> D2{Платёжная система: Платёж успешен?}
    
    D2 -->|Нет| E2[Приложение: Уведомление - ошибка оплаты]
    E2 --> End2([Конец - отмена])
    
    D2 -->|Да| D3[Платёжная система: Подтверждает оплату]
    D3 --> C5
    
    C4 -->|Нет - при получении| C5[API-сервер: Отправляет заказ в аптеку]
    C5 --> C6[API-сервер: Push-уведомление - заказ принят]
    
    C6 --> F1[Аптека: Получает заказ]
    F1 --> F2[Аптека: Проверяет рецепты]
    F2 --> F3[Аптека: Фармацевт собирает заказ]
    F3 --> F4[Аптека: Упаковывает товары]
    
    F4 --> F5{Аптека: Способ получения?}
    
    F5 -->|Самовывоз| G1[Аптека: Размещает в зоне выдачи]
    G1 --> G2[API-сервер: Push - заказ готов]
    G2 --> G3[Пользователь: Приходит в аптеку]
    G3 --> G4[Пользователь: Предъявляет код]
    G4 --> G5[Аптека: Выдаёт заказ]
    G5 --> G6{Оплата при получении?}
    G6 -->|Да| G7[Аптека: Принимает оплату]
    G7 --> H1
    G6 -->|Нет| H1
    
    F5 -->|Доставка| I1[Курьер: Принимает заказ]
    I1 --> I2[Курьер: Доставляет по адресу]
    I2 --> I3[Пользователь: Получает заказ]
    I3 --> I4{Оплата при получении?}
    I4 -->|Да| I5[Курьер: Принимает оплату]
    I5 --> H1
    I4 -->|Нет| H1
    
    H1[API-сервер: Обновляет статус - Завершён]
    H1 --> H2[API-сервер: Начисляет бонусы]
    H2 --> H3[API-сервер: Запрос на отзыв]
    H3 --> H4[Пользователь: Уведомление о завершении]
    
    H4 --> End3([Конец - успех])
    
    style Start fill:#fff,stroke:#000
    style End1 fill:#fff,stroke:#000
    style End2 fill:#fff,stroke:#000
    style End3 fill:#fff,stroke:#000
    
    style A1 fill:#e3f2fd,stroke:#000
    style A2 fill:#e3f2fd,stroke:#000
    style A3 fill:#e3f2fd,stroke:#000
    style A5 fill:#e3f2fd,stroke:#000
    style A6 fill:#e3f2fd,stroke:#000
    style A7 fill:#e3f2fd,stroke:#000
    style G3 fill:#e3f2fd,stroke:#000
    style G4 fill:#e3f2fd,stroke:#000
    style I3 fill:#e3f2fd,stroke:#000
    style H4 fill:#e3f2fd,stroke:#000
    
    style B1 fill:#fff9c4,stroke:#000
    style B2 fill:#fff9c4,stroke:#000
    style E1 fill:#fff9c4,stroke:#000
    style E2 fill:#fff9c4,stroke:#000
    
    style C1 fill:#f3e5f5,stroke:#000
    style C3 fill:#f3e5f5,stroke:#000
    style C5 fill:#f3e5f5,stroke:#000
    style C6 fill:#f3e5f5,stroke:#000
    style G2 fill:#f3e5f5,stroke:#000
    style H1 fill:#f3e5f5,stroke:#000
    style H2 fill:#f3e5f5,stroke:#000
    style H3 fill:#f3e5f5,stroke:#000
    
    style D1 fill:#c8e6c9,stroke:#000
    style D3 fill:#c8e6c9,stroke:#000
    
    style F1 fill:#ffe0b2,stroke:#000
    style F2 fill:#ffe0b2,stroke:#000
    style F3 fill:#ffe0b2,stroke:#000
    style F4 fill:#ffe0b2,stroke:#000
    style G1 fill:#ffe0b2,stroke:#000
    style G5 fill:#ffe0b2,stroke:#000
    style G7 fill:#ffe0b2,stroke:#000
    
    style I1 fill:#ffccbc,stroke:#000
    style I2 fill:#ffccbc,stroke:#000
    style I5 fill:#ffccbc,stroke:#000
